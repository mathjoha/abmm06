---
title: "Databehandling och rensning"
subtitle: "Interaktiv demonstration av outliers och transformationer"
citation:
  type: document
  title: "Databehandling - Interaktiv visualisering"
  container-title: "ABMM06: Kvantitativa metoder"
  publisher: Lunds universitet
  license: "CC-BY-NC 4.0"
  url: https://mathjoha.github.io/abmm06/dashboards/data-cleaning-viz.html
format:
  html:
    page-layout: full
    toc: true
---

## Utforska outliers och transformationer

Denna interaktiva visualisering visar hur outliers och datatransformationer pÃ¥verkar statistiska mÃ¥tt.

```{ojs}
//| echo: false

viewof includeOutlier = Inputs.toggle({
  label: "Inkludera outlier (extremvÃ¤rde)",
  value: true
})

viewof transformation = Inputs.select(
  ["Ingen", "Logaritm (logâ‚â‚€)", "Kvadratrot", "Z-score standardisering"],
  {
    label: "VÃ¤lj transformation:",
    value: "Ingen"
  }
)

viewof outlierValue = Inputs.range([100, 500], {
  label: "Outlier-vÃ¤rde:",
  step: 10,
  value: 200
})
```

```{ojs}
//| echo: false

// Generate base data
baseData = [
  15, 18, 20, 22, 24, 25, 26, 28, 30, 32,
  34, 35, 38, 40, 42, 45, 48, 50, 52, 55
]

// Add outlier if selected
rawData = includeOutlier ? [...baseData, outlierValue] : baseData
```

```{ojs}
//| echo: false

// Apply transformation
transformedData = {
  if (transformation === "Ingen") {
    return rawData;
  } else if (transformation === "Logaritm (logâ‚â‚€)") {
    return rawData.map(x => Math.log10(x));
  } else if (transformation === "Kvadratrot") {
    return rawData.map(x => Math.sqrt(x));
  } else if (transformation === "Z-score standardisering") {
    const mean = d3.mean(rawData);
    const std = d3.deviation(rawData);
    return rawData.map(x => (x - mean) / std);
  }
}

displayData = transformedData
```

```{ojs}
//| echo: false

// Calculate statistics
stats = {
  const data = displayData;
  const sorted = [...data].sort((a, b) => a - b);
  const n = data.length;

  const mean = d3.mean(data);
  const median = d3.median(data);
  const stdDev = d3.deviation(data);
  const min = d3.min(data);
  const max = d3.max(data);

  // Quartiles
  const q1 = d3.quantile(sorted, 0.25);
  const q3 = d3.quantile(sorted, 0.75);
  const iqr = q3 - q1;

  // Outlier bounds (IQR method)
  const lowerBound = q1 - 1.5 * iqr;
  const upperBound = q3 + 1.5 * iqr;

  // Count outliers
  const outliers = data.filter(x => x < lowerBound || x > upperBound);

  return {
    mean, median, stdDev, min, max,
    q1, q3, iqr,
    lowerBound, upperBound,
    outliers: outliers.length,
    n
  };
}
```

## Visualiseringar

```{ojs}
//| echo: false

// Histogram
Plot.plot({
  width: 700,
  height: 400,
  marginLeft: 60,
  x: {
    label: transformation === "Ingen" ? "VÃ¤rde" : `VÃ¤rde (${transformation})`
  },
  y: {
    label: "Frekvens"
  },
  marks: [
    Plot.rectY(displayData, Plot.binX({y: "count"}, {x: d => d, fill: "steelblue"})),
    Plot.ruleX([stats.mean], {stroke: "red", strokeWidth: 2}),
    Plot.ruleX([stats.median], {stroke: "green", strokeWidth: 2, strokeDasharray: "4,2"})
  ]
})
```

**FÃ¶rklaring:**
- **RÃ¶d linje**: MedelvÃ¤rde
- **GrÃ¶n streckad linje**: Median

```{ojs}
//| echo: false

// Boxplot
Plot.plot({
  width: 700,
  height: 200,
  marginLeft: 60,
  x: {
    label: transformation === "Ingen" ? "VÃ¤rde" : `VÃ¤rde (${transformation})`
  },
  marks: [
    Plot.boxX(displayData, {x: d => d, fill: "lightblue", stroke: "steelblue"}),
    // Mark outliers according to IQR rule
    Plot.dot(
      displayData.filter(x => x < stats.lowerBound || x > stats.upperBound),
      {x: d => d, fill: "red", r: 5}
    )
  ]
})
```

**FÃ¶rklaring:**
- **Box**: Visar Q1, median, Q3
- **Whiskers**: StrÃ¤cker sig till min/max inom 1.5Ã—IQR
- **RÃ¶da punkter**: Outliers enligt IQR-metoden

## Statistik

```{ojs}
//| echo: false

md`
| MÃ¥tt | VÃ¤rde |
|------|-------|
| Antal observationer | ${stats.n} |
| MedelvÃ¤rde (mean) | ${stats.mean.toFixed(2)} |
| Median | ${stats.median.toFixed(2)} |
| Standardavvikelse | ${stats.stdDev.toFixed(2)} |
| Minimum | ${stats.min.toFixed(2)} |
| Maximum | ${stats.max.toFixed(2)} |
| Q1 (25:e percentilen) | ${stats.q1.toFixed(2)} |
| Q3 (75:e percentilen) | ${stats.q3.toFixed(2)} |
| IQR (Q3 - Q1) | ${stats.iqr.toFixed(2)} |
| Antal outliers (IQR-metod) | ${stats.outliers} |

${transformation === "Ingen" ? `
### Skillnad med/utan outlier

${includeOutlier ? `
Med outlier (${outlierValue}):
- MedelvÃ¤rde pÃ¥verkas kraftigt av extremvÃ¤rdet
- Medianen Ã¤r mer robust och pÃ¥verkas mindre
` : `
Utan outlier:
- MedelvÃ¤rde och median ligger nÃ¤rmare varandra
- LÃ¤gre standardavvikelse
`}
` : ""}
`
```

## JÃ¤mfÃ¶relse: RÃ¥data vs Transformerad data

```{ojs}
//| echo: false

comparison = {
  const rawStats = {
    mean: d3.mean(rawData),
    median: d3.median(rawData),
    std: d3.deviation(rawData),
    min: d3.min(rawData),
    max: d3.max(rawData)
  };

  return {raw: rawStats, transformed: stats};
}

md`
| MÃ¥tt | RÃ¥data | ${transformation !== "Ingen" ? "Transformerad" : ""} |
|------|--------|-------------|
| MedelvÃ¤rde | ${comparison.raw.mean.toFixed(2)} | ${transformation !== "Ingen" ? stats.mean.toFixed(2) : "â€“"} |
| Median | ${comparison.raw.median.toFixed(2)} | ${transformation !== "Ingen" ? stats.median.toFixed(2) : "â€“"} |
| Std.avvikelse | ${comparison.raw.std.toFixed(2)} | ${transformation !== "Ingen" ? stats.stdDev.toFixed(2) : "â€“"} |
| Min | ${comparison.raw.min.toFixed(2)} | ${transformation !== "Ingen" ? stats.min.toFixed(2) : "â€“"} |
| Max | ${comparison.raw.max.toFixed(2)} | ${transformation !== "Ingen" ? stats.max.toFixed(2) : "â€“"} |

${transformation === "Logaritm (logâ‚â‚€)" ? `
### Tolkning av log-transformation

FÃ¶r att konvertera tillbaka:
- Om logâ‚â‚€(x) = ${stats.mean.toFixed(2)}, dÃ¥ x = 10^${stats.mean.toFixed(2)} â‰ˆ ${Math.pow(10, stats.mean).toFixed(1)}

**Effekt:** Logaritmtransformation komprimerar stora vÃ¤rden mer Ã¤n smÃ¥ vÃ¤rden, vilket minskar effekten av outliers.
` : ""}

${transformation === "Kvadratrot" ? `
### Tolkning av kvadratrotstransformation

FÃ¶r att konvertera tillbaka:
- Om âˆšx = ${stats.mean.toFixed(2)}, dÃ¥ x = (${stats.mean.toFixed(2)})Â² â‰ˆ ${Math.pow(stats.mean, 2).toFixed(1)}

**Effekt:** Kvadratrotstransformation minskar skevhet i mÃ¥ttlig grad, mindre drastisk Ã¤n log-transformation.
` : ""}

${transformation === "Z-score standardisering" ? `
### Tolkning av Z-score standardisering

**Resultat:**
- MedelvÃ¤rde = ${stats.mean.toFixed(2)} (nÃ¤ra 0)
- Standardavvikelse = ${stats.stdDev.toFixed(2)} (nÃ¤ra 1)

**AnvÃ¤ndning:** JÃ¤mfÃ¶ra variabler med olika skalor, eller identifiera outliers (|z| > 2 eller 3).
` : ""}
`
```

## Identifiera outliers

```{ojs}
//| echo: false

// Z-scores for raw data
zScores = {
  const mean = d3.mean(rawData);
  const std = d3.deviation(rawData);
  return rawData.map((x, i) => ({
    value: x,
    z: (x - mean) / std,
    index: i
  }));
}

outliersTable = zScores.filter(d => Math.abs(d.z) > 2)

md`
### Z-score metoden

VÃ¤rden med |Z| > 2 betraktas som mÃ¶jliga outliers:

${outliersTable.length > 0 ? `
| VÃ¤rde | Z-score | Tolkning |
|-------|---------|----------|
${outliersTable.map(d => `| ${d.value.toFixed(1)} | ${d.z.toFixed(2)} | ${Math.abs(d.z) > 3 ? "Stark outlier" : "MÃ¶jlig outlier"} |`).join('\n')}
` : "*Inga outliers identifierade med Z-score metoden*"}

### IQR-metoden

**GrÃ¤nser:**
- Nedre grÃ¤ns: Q1 - 1.5 Ã— IQR = ${comparison.raw.median !== undefined ? (stats.q1 - 1.5 * stats.iqr).toFixed(2) : "â€“"}
- Ã–vre grÃ¤ns: Q3 + 1.5 Ã— IQR = ${comparison.raw.median !== undefined ? (stats.q3 + 1.5 * stats.iqr).toFixed(2) : "â€“"}

**Outliers:** ${stats.outliers} vÃ¤rden ligger utanfÃ¶r dessa grÃ¤nser
`
```

## Praktiska insikter

```{ojs}
//| echo: false

md`
### NÃ¤r ska du ta bort outliers?

âœ… **Ta bort nÃ¤r:**
- Uppenbart mÃ¤tfel (t.ex. Ã¥lder = 999)
- Datainmatningsfel som kan verifieras
- VÃ¤rdet inte tillhÃ¶r mÃ¥lpopulationen

âŒ **BehÃ¥ll nÃ¤r:**
- Genuina extremvÃ¤rden som Ã¤r viktiga fÃ¶r studien
- Du studerar extremfall eller sÃ¤llsynta hÃ¤ndelser
- Outliers ger viktig information om variabiliteten

### NÃ¤r ska du transformera data?

âœ… **AnvÃ¤nd log-transformation fÃ¶r:**
- HÃ¶ger-skev data (lÃ¥ng svans Ã¥t hÃ¶ger)
- Data som spÃ¤nner flera storleksordningar
- Inkomst, priser, befolkningsstorlek

âœ… **AnvÃ¤nd kvadratrot fÃ¶r:**
- MÃ¥ttligt skev data
- RÃ¤knedata (count data)

âœ… **AnvÃ¤nd Z-score standardisering fÃ¶r:**
- JÃ¤mfÃ¶ra variabler med olika enheter
- Identifiera outliers numeriskt
- FÃ¶rberedelse fÃ¶r vissa analyser

### Viktig pÃ¥minnelse

ğŸ“Š **Rapportera alltid:**
- Vilka transformationer som anvÃ¤nts
- Antal borttagna outliers
- Motivering fÃ¶r beslut
- Effekt pÃ¥ resultat
`
```

## Experimentera!

Prova att:
1. **SlÃ¥ pÃ¥/av outlier** - Se hur det pÃ¥verkar medelvÃ¤rde vs median
2. **Ã„ndra outlier-vÃ¤rdet** - Se nÃ¤r det blir extremt nog att klassas som outlier
3. **Applicera log-transformation** - Observera hur extremvÃ¤rden komprimeras
4. **JÃ¤mfÃ¶r transformationer** - Vilken fungerar bÃ¤st fÃ¶r denna data?

## LÃ¤s mer

Se [Databehandling och rensning](../lessons/databehandling.qmd) fÃ¶r detaljerad fÃ¶rklaring av outliers, transformationer och best practices.
